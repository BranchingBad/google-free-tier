name: CI
on: [push, pull_request]

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate shell scripts
        run: shellcheck -x **/*.sh

      - name: Lint Dockerfile
        uses: hadolint/action-hadolint@v3.1.0
        with:
          dockerfile: app/Dockerfile
          ignore: DL3008,DL3009

      - name: Validate JSON files
        run: |
          find . -name "*.json" -not -path "./node_modules/*" -not -path "./.terraform/*" | while read f; do
            echo "Validating $f..."
            jq empty "$f" || exit 1
          done

      - name: Lint YAML files
        run: |
          pip install yamllint
          yamllint -c '{extends: default, rules: {line-length: {max: 120}, comments: {min-spaces-from-content: 1}}}' \
            .github/ terraform/ 2>/dev/null || true

      - name: Lint Markdown files
        uses: nosborn/github-action-markdown-cli@v3.3.0
        with:
          files: .

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  terraform:
    name: Terraform Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.4

      - name: Terraform format check
        working-directory: terraform
        run: terraform fmt -check -recursive

      - name: Terraform init
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: terraform
        run: terraform validate

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
        if: always()

  validate:
    name: Code Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate scripts
        run: shellcheck -x **/*.sh

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.4

      - name: Terraform validate
        working-directory: terraform
        run: terraform init -backend=false && terraform validate

  release:
    name: Create GitHub Release
    needs: [validate]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate SHA256 checksums for release assets
        run: |
          # Create dist directory and generate checksums for release artifacts
          mkdir -p dist/
          # Add files to dist if they exist (scripts, terraform configs, docker image info, etc.)
          if [ -d "app/" ]; then cp -r app/ dist/; fi
          if [ -d "terraform/" ]; then cp -r terraform/ dist/; fi
          if [ -d "scripts/" ]; then cp -r scripts/ dist/; fi
          if [ -f "README.md" ]; then cp README.md dist/; fi
          # Generate checksums for all files in dist
          cd dist && find . -type f ! -name "sha256sums.txt" -exec sha256sum {} \; > sha256sums.txt && cd ..

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          files: |
            dist/sha256sums.txt
            dist/README.md
            dist/app/**/*
            dist/terraform/**/*
            dist/scripts/**/*
